<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AURA | Peptides — Conversor</title>
  <style>
    :root{
      --bg:#f5f5f5;
      --bg2:#ececec;
      --card:#ffffff;
      --line:#e0e0e0;
      --text:#111111;
      --muted:#777777;
      --accent:#111111;
      --good:#1a7a4a;
      --warn:#a05c00;
      --bad:#b01c1c;
      --shadow:0 4px 20px rgba(0,0,0,.07);
      --radius:16px;
      --pad:20px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    [data-theme="dark"]{
      --bg:#0d0d0d;
      --bg2:#161616;
      --card:#1a1a1a;
      --line:#2a2a2a;
      --text:#f0f0f0;
      --muted:#777777;
      --accent:#f0f0f0;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow:0 4px 24px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box;transition:background .2s,color .2s,border-color .2s}
    body{margin:0;font-family:var(--font);color:var(--text);background:var(--bg);min-height:100vh}
    .wrap{max-width:1040px;margin:0 auto;padding:28px 18px 36px}

    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:14px}
    .logoImg{width:46px;height:46px;border-radius:10px;border:1px solid var(--line);object-fit:contain;padding:5px;background:var(--card)}
    .brandText h1{margin:0;font-size:17px;font-weight:700;letter-spacing:.3px}
    .brandText p{margin:0;font-size:12px;color:var(--muted);margin-top:2px}
    .headerRight{display:flex;gap:10px;align-items:center}
    .toggle{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:999px;border:1px solid var(--line);background:var(--card);color:var(--muted);font-size:12px;cursor:pointer;user-select:none;box-shadow:var(--shadow)}
    .dot{width:30px;height:16px;border-radius:999px;background:var(--line);position:relative;border:1px solid var(--line)}
    .dot::after{content:"";position:absolute;top:50%;transform:translateY(-50%);left:2px;width:12px;height:12px;border-radius:50%;background:var(--muted);transition:all .2s}
    [data-theme="dark"] .dot::after{left:14px;background:var(--text)}

    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card-hd{padding:14px var(--pad);border-bottom:1px solid var(--line)}
    .card-hd h2{margin:0;font-size:12px;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);font-weight:600}
    .card-bd{padding:var(--pad)}

    .section{border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:12px;background:var(--bg)}
    .section-title{font-size:11px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--muted);margin:0 0 12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:540px){.row{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:5px;font-weight:500}
    input,select{width:100%;padding:11px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--text);outline:none;font-size:14px}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in srgb,var(--accent) 12%,transparent)}
    .hint{font-size:11.5px;color:var(--muted);margin-top:7px;line-height:1.4}

    .btnrow{display:flex;gap:8px;flex-wrap:wrap}
    button{padding:10px 16px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--text);cursor:pointer;font-size:13px;font-weight:500}
    button:hover{background:var(--bg2)}
    button.primary{background:var(--text);color:var(--card);border-color:var(--text)}
    button.primary:hover{opacity:.87}

    /* Search dropdown */
    .preset-wrap{position:relative}
    #presetSearch{padding-right:30px}
    #presetClear{position:absolute;right:10px;top:34px;cursor:pointer;color:var(--muted);font-size:18px;display:none;line-height:1;user-select:none}
    #presetDropdown{
      display:none;position:absolute;z-index:99;left:0;right:0;
      background:var(--card);border:1px solid var(--line);border-radius:10px;
      box-shadow:var(--shadow);max-height:220px;overflow-y:auto;margin-top:3px
    }
    .dd-item{padding:10px 13px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--line)}
    .dd-item:last-child{border-bottom:none}
    .dd-item:hover,.dd-item.active{background:var(--bg2)}
    .dd-item .dd-name{font-weight:600}
    .dd-item .dd-dose{font-size:11px;color:var(--muted);margin-top:1px}
    .dd-empty{padding:12px 13px;font-size:13px;color:var(--muted);text-align:center}

    /* Result hero */
    .result-hero{background:var(--text);color:var(--card);border-radius:14px;padding:20px 22px;margin-bottom:14px;text-align:center}
    .result-hero .label{font-size:11px;letter-spacing:.6px;text-transform:uppercase;opacity:.55;margin-bottom:4px}
    .result-hero .value{font-size:52px;font-weight:800;letter-spacing:-1px;line-height:1}
    .result-hero .sub{font-size:13px;opacity:.55;margin-top:6px}

    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
    @media(max-width:540px){.kpis{grid-template-columns:1fr}}
    .kpi{border:1px solid var(--line);border-radius:12px;padding:12px 14px;background:var(--bg)}
    .kpi .t{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;font-weight:600}
    .kpi .v{font-size:20px;font-weight:700;margin-top:4px}
    .kpi .s{font-size:12px;color:var(--muted);margin-top:2px}

    .alerts{display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
    .alert{border-left:3px solid var(--warn);background:color-mix(in srgb,var(--warn) 8%,transparent);padding:9px 12px;border-radius:0 10px 10px 0;font-size:12px;line-height:1.45;color:var(--text)}
    .alert.bad{border-left-color:var(--bad);background:color-mix(in srgb,var(--bad) 8%,transparent)}
    .alert.good{border-left-color:var(--good);background:color-mix(in srgb,var(--good) 8%,transparent)}
    .alert.neutral{border-left-color:var(--muted);background:var(--bg)}

    .sumGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:540px){.sumGrid{grid-template-columns:1fr}}
    .sumItem{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:var(--bg)}
    .sumItem .sl{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.3px}
    .sumItem .sv{font-size:14px;font-weight:700;margin-top:3px}

    .syrWrap{display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;margin-top:14px}
    .syrCard{border:1px solid var(--line);border-radius:14px;padding:14px;background:var(--bg)}

    .ruo{margin-top:14px;padding:10px 12px;border-radius:10px;border:1px dashed var(--line);background:var(--bg);font-size:11.5px;color:var(--muted);line-height:1.5}

    footer{margin-top:18px;padding-top:14px;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;color:var(--muted);font-size:12px}
    .links{display:flex;gap:8px;flex-wrap:wrap}
    .linkBtn{display:inline-flex;align-items:center;gap:7px;padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--card);color:var(--text);text-decoration:none;font-size:12px}
    .linkBtn:hover{background:var(--bg2)}
    .iconImg{width:16px;height:16px;object-fit:contain}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Courier New",monospace}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <img class="logoImg" src="logo-aura-vertical.png" alt="AURA | Peptides">
      <div class="brandText">
        <h1>AURA | Peptides &mdash; Conversor</h1>
        <p>Convers&atilde;o educativa: mg &harr; mL &harr; UI. N&atilde;o define dosagem.</p>
      </div>
    </div>
    <div class="headerRight">
      <div class="toggle" id="themeToggle" title="Alternar modo claro/escuro">
        <span id="themeLabel">Claro</span><span class="dot"></span>
      </div>
    </div>
  </header>

  <div class="grid">
    <!-- ENTRADAS -->
    <section class="card">
      <div class="card-hd"><h2>Entradas</h2></div>
      <div class="card-bd">

        <div class="section">
          <p class="section-title">Dose desejada</p>
          <div class="row">
            <div>
              <label>Valor</label>
              <input id="doseValue" type="number" step="0.01" min="0" value="0.25"/>
            </div>
            <div>
              <label>Unidade</label>
              <select id="doseUnit">
                <option value="mg">mg</option>
                <option value="mcg">mcg</option>
                <option value="ui">UI</option>
              </select>
            </div>
          </div>
        </div>

        <div class="section">
          <p class="section-title">Pept&iacute;deo</p>
          <div class="row">
            <div class="preset-wrap">
              <label>Produto</label>
              <input id="presetSearch" type="text" placeholder="Buscar produto..." autocomplete="off"/>
              <span id="presetClear">&#215;</span>
              <div id="presetDropdown"></div>
              <input type="hidden" id="preset" value="custom"/>
            </div>
            <div>
              <label>Total no vial (mg)</label>
              <input id="vialMg" type="number" step="0.01" min="0" value="10"/>
              <div class="hint">Preenchido automaticamente ao selecionar o produto.</div>
            </div>
          </div>
        </div>

        <div class="section">
          <p class="section-title">Dilui&ccedil;&atilde;o</p>
          <div class="row">
            <div>
              <label>Modo</label>
              <select id="dilutionMode">
                <option value="preset">Padr&atilde;o</option>
                <option value="custom">Personalizado</option>
              </select>
            </div>
            <div id="dilutionPresetWrap">
              <label>Volume (mL)</label>
              <select id="dilutionMlPreset">
                <option value="1">1 mL</option>
                <option value="2" selected>2 mL</option>
                <option value="2.5">2,5 mL</option>
                <option value="3">3 mL</option>
              </select>
            </div>
            <div id="dilutionCustomWrap" style="display:none">
              <label>Volume personalizado (mL)</label>
              <input id="dilutionMlCustom" type="number" step="0.01" min="0" value="2.0"/>
            </div>
          </div>
        </div>

        <div class="section">
          <p class="section-title">Seringa</p>
          <div class="row">
            <div>
              <label>Tipo</label>
              <select id="syringeType">
                <option value="u100-1">1,0 mL &mdash; 100 UI</option>
                <option value="u100-0_5">0,5 mL &mdash; 50 UI</option>
                <option value="u100-0_3">0,3 mL &mdash; 30 UI</option>
              </select>
              <div class="hint">Escala: 100 UI = 1 mL</div>
            </div>
            <div>
              <label>Arredondamento</label>
              <select id="rounding">
                <option value="2">2 UI (recomendado)</option>
                <option value="1">1 UI</option>
                <option value="0">Sem arredondamento</option>
              </select>
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <div>
              <label>Regra de empate</label>
              <select id="tieRule">
                <option value="up">Arredondar para cima</option>
                <option value="down">Arredondar para baixo</option>
              </select>
            </div>
          </div>
        </div>

        <div class="btnrow">
          <button class="primary" id="copyLinkBtn">Copiar link</button>
          <button id="resetBtn">Resetar</button>
        </div>
      </div>
    </section>

    <!-- RESULTADO -->
    <section class="card">
      <div class="card-hd"><h2>Resultado</h2></div>
      <div class="card-bd">

        <div class="result-hero">
          <div class="label">Aspire at&eacute;</div>
          <div class="value mono" id="heroUI">&mdash;</div>
          <div class="sub" id="heroML">Preencha os campos para calcular</div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="t">UI exato</div>
            <div class="v mono" id="uiExact">&mdash;</div>
            <div class="s" id="uiExactSub"></div>
          </div>
          <div class="kpi">
            <div class="t">UI arredondado</div>
            <div class="v mono" id="uiShown">&mdash;</div>
            <div class="s" id="uiShownSub"></div>
          </div>
        </div>

        <div class="alerts" id="alerts"></div>

        <div class="syrWrap">
          <div class="syrCard">
            <p class="section-title" style="margin-bottom:10px">Visual da seringa</p>
            <svg id="syringeSvg" width="120" height="420" viewBox="0 0 120 420" role="img" aria-label="Seringa" style="display:block">
              <rect x="0" y="0" width="120" height="420" fill="transparent"/>
              <rect x="22" y="74" width="76" height="16" rx="8" fill="none" stroke="currentColor" stroke-width="2.2" opacity=".9"/>
              <rect x="40" y="8" width="40" height="26" rx="6" fill="none" stroke="currentColor" stroke-width="2" opacity=".9"/>
              <rect x="56" y="34" width="8" height="40" rx="4" fill="none" stroke="currentColor" stroke-width="1.8" opacity=".9"/>
              <rect x="28" y="90" width="64" height="270" rx="14" fill="none" stroke="currentColor" stroke-width="2.4" opacity=".9"/>
              <clipPath id="bClip"><rect x="34" y="96" width="52" height="258" rx="10"/></clipPath>
              <rect id="liquid" x="34" y="354" width="52" height="0" fill="#555555" opacity=".7" clip-path="url(#bClip)"/>
              <rect x="44" y="360" width="32" height="14" rx="5" fill="none" stroke="currentColor" stroke-width="2.2" opacity=".9"/>
              <line x1="60" y1="374" x2="60" y2="404" stroke="currentColor" stroke-width="2.4" opacity=".9"/>
              <polygon points="60,412 52,402 68,402" fill="currentColor" opacity=".9"/>
              <g id="ticks"></g>
              <line id="plungerBase" x1="28" y1="354" x2="92" y2="354" stroke="currentColor" stroke-width="2.6" opacity="1" stroke-dasharray="3 2"/>
              <text id="plungerLabel" x="60" y="0" text-anchor="middle" fill="currentColor" font-size="10" opacity=".7">base</text>
            </svg>
            <div class="hint" style="margin-top:8px">Leia pela <strong>base do &ecirc;mbolo</strong></div>
          </div>

          <div style="flex:1;min-width:180px">
            <p class="section-title">Resumo</p>
            <div class="sumGrid">
              <div class="sumItem"><div class="sl">Vial</div><div class="sv mono" id="sumVial">&mdash;</div></div>
              <div class="sumItem"><div class="sl">Dilui&ccedil;&atilde;o</div><div class="sv mono" id="sumDil">&mdash;</div></div>
              <div class="sumItem"><div class="sl">Dose</div><div class="sv mono" id="sumDose">&mdash;</div></div>
              <div class="sumItem"><div class="sl">Aspire</div><div class="sv mono" id="sumAspire">&mdash;</div></div>
            </div>
            <div class="hint" id="roundingNote" style="margin-top:8px"></div>
            <div class="ruo">
              <strong>RUO</strong> &mdash; Research Use Only. Not for human or veterinary use.<br>
              Este conversor &eacute; educativo e n&atilde;o substitui orienta&ccedil;&atilde;o profissional.
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <footer>
    <div>&copy; AURA | Peptides</div>
    <div class="links">
      <a class="linkBtn" href="https://instagram.com/aura_peptides" target="_blank" rel="noopener">
        <img class="iconImg" src="instagram.png" alt=""> Instagram
      </a>
      <a class="linkBtn" href="https://wa.me/5511973616286" target="_blank" rel="noopener">
        <img class="iconImg" src="4d5de593-cd24-43a1-b73b-273dabd7690d.png" alt=""> WhatsApp
      </a>
      <a class="linkBtn" href="/cdn-cgi/l/email-protection#99e9fce9edf0fdfceab7f8ecebf8d9fef4f8f0f5b7faf6f4">
        <img class="iconImg" src="maildotru.png" alt=""> E-mail
      </a>
    </div>
  </footer>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
<script>
  const qs = id => document.getElementById(id);
  const toNum = v => Number(String(v).replace(',','.'));
  const fmt = (n, d=2) => Number.isFinite(n) ? n.toFixed(d).replace('.',',') : '\u2014';

  const PRESETS = {
    "5-Amino-1MQ":["5 MG","10 MG","50 MG"],
    "ACE-031":["1 MG"],
    "Acetic Acid":["3 ML"],
    "Adamax":["5 MG","10 MG"],
    "Adipotide":["2 MG","5 MG","10 MG"],
    "AHK-CU":["100 MG"],
    "AICAR":["50 MG","100 MG"],
    "Alprostadil":["20 MCG"],
    "AOD-9604":["2 MG","5 MG","10 MG"],
    "ARA-290":["5 MG","10 MG"],
    "BPC-157":["2 MG","5 MG","10 MG","15 MG","20 MG","50 MG","70 MG","80 MG"],
    "Cagrilintide":["2 MG","5 MG","10 MG","20 MG"],
    "CJC-1295 (no DAC)":["2 MG","5 MG","10 MG"],
    "CJC-1295 (with DAC)":["2 MG","5 MG","10 MG"],
    "DSIP":["2 MG","5 MG","10 MG","12 MG","15 MG"],
    "Dulaglutide":["5 MG","10 MG"],
    "Epithalon":["5 MG","10 MG","40 MG","50 MG"],
    "EPO":["3000 IU","5000 IU"],
    "GHK-Cu":["10 MG","50 MG","100 MG"],
    "GHRP-2":["5 MG","10 MG","15 MG"],
    "GHRP-6":["5 MG","10 MG"],
    "HCG":["1000 IU","2000 IU","5000 IU","10000 IU"],
    "Hexarelin":["2 MG","5 MG","10 MG"],
    "HGH (191AA)":["6 IU","8 IU","10 IU","12 IU","15 IU","24 IU","36 IU","40 IU","50 IU"],
    "HGH Fragment 176-191":["1 MG","2 MG","5 MG","10 MG","12 MG","15 MG"],
    "IGF-1 DES":["100 MCG"],
    "IGF-1 LR3":["1 MG","100 MCG"],
    "Ipamorelin":["2 MG","5 MG","10 MG"],
    "KPV":["5 MG","10 MG"],
    "Liraglutide":["5 MG","10 MG","30 MG"],
    "LL-37":["5 MG","10 MG"],
    "Mazdutide":["5 MG","10 MG","20 MG"],
    "Melanotan I":["5 MG","10 MG"],
    "Melanotan II":["5 MG","10 MG"],
    "MOTS-C":["5 MG","10 MG","40 MG"],
    "NAD+":["100 MG","500 MG","1000 MG"],
    "Oxytocin":["2 MG","5 MG","10 MG"],
    "PEG-MGF":["2 MG","10 MG"],
    "Pramlintide":["5 MG","10 MG"],
    "Retatrutide":["5 MG","10 MG","15 MG","20 MG","25 MG","30 MG","35 MG","40 MG","50 MG","60 MG","100 MG"],
    "Semaglutide":["2 MG","5 MG","10 MG","15 MG","20 MG","30 MG","50 MG"],
    "Semax":["5 MG","10 MG","30 MG"],
    "Sermorelin":["2 MG","5 MG","10 MG","15 MG"],
    "SLU-PP-332":["5 MG","10 MG"],
    "SS-31":["5 MG","10 MG","25 MG","50 MG"],
    "Survodutide":["5 MG","10 MG"],
    "TB-500":["2 MG","5 MG","10 MG","20 MG"],
    "Tesamorelin":["2 MG","5 MG","10 MG","15 MG","20 MG"],
    "Thymosin Alpha-1":["2 MG","5 MG","10 MG","12 MG","15 MG"],
    "Tirzepatide":["2 MG","5 MG","10 MG","15 MG","20 MG","30 MG","40 MG","45 MG","50 MG","60 MG","70 MG","80 MG","90 MG","100 MG","110 MG","120 MG"],
    "VIP":["5 MG","10 MG"],
    "Vitamin D3":["20000 IU"]
  };

  // Flat list for search
  const PRESET_LIST = [];
  Object.keys(PRESETS).sort().forEach(name => {
    PRESETS[name].forEach(dose => {
      PRESET_LIST.push({ name, dose, value: name + '|' + dose, label: name + ' \u2014 ' + dose });
    });
  });

  // ── SEARCHABLE PRESET ──
  let ddOpen = false;
  let selectedPreset = { value:'custom', name:'Personalizado', dose:'' };

  function openDropdown(items) {
    const dd = qs('presetDropdown');
    dd.innerHTML = '';
    if (!items.length) {
      dd.innerHTML = '<div class="dd-empty">Nenhum produto encontrado</div>';
    } else {
      // Always show "Personalizado" at top
      const customEl = document.createElement('div');
      customEl.className = 'dd-item';
      customEl.innerHTML = '<div class="dd-name">Personalizado</div>';
      customEl.addEventListener('mousedown', () => selectPreset({ value:'custom', name:'Personalizado', dose:'' }));
      dd.appendChild(customEl);

      items.forEach(item => {
        const el = document.createElement('div');
        el.className = 'dd-item';
        el.innerHTML = '<div class="dd-name">' + item.name + '</div><div class="dd-dose">' + item.dose + '</div>';
        el.addEventListener('mousedown', () => selectPreset(item));
        dd.appendChild(el);
      });
    }
    dd.style.display = 'block';
    ddOpen = true;
  }

  function closeDropdown() {
    qs('presetDropdown').style.display = 'none';
    ddOpen = false;
  }

  function selectPreset(item) {
    selectedPreset = item;
    qs('preset').value = item.value;
    qs('presetSearch').value = item.value === 'custom' ? '' : item.label;
    qs('presetClear').style.display = item.value === 'custom' ? 'none' : 'block';
    closeDropdown();
    applyPreset(item);
  }

  function applyPreset(item) {
    if (item.value === 'custom') { update(); return; }
    const doseStr = item.dose.trim().toUpperCase();
    const numeric = Number(doseStr.replace(/[^\d.]/g,''));
    qs('vialMg').value = doseStr.includes('MCG') ? numeric/1000 : numeric;
    update();
  }

  qs('presetSearch').addEventListener('focus', () => {
    const q = qs('presetSearch').value.trim().toLowerCase();
    openDropdown(q ? PRESET_LIST.filter(i => i.name.toLowerCase().includes(q)) : PRESET_LIST);
  });

  qs('presetSearch').addEventListener('input', () => {
    const q = qs('presetSearch').value.trim().toLowerCase();
    qs('presetClear').style.display = q ? 'block' : 'none';
    if (!q) { selectedPreset = { value:'custom', name:'Personalizado', dose:'' }; qs('preset').value='custom'; }
    openDropdown(q ? PRESET_LIST.filter(i => i.name.toLowerCase().includes(q)) : PRESET_LIST);
  });

  qs('presetSearch').addEventListener('blur', () => {
    setTimeout(closeDropdown, 150);
  });

  qs('presetClear').addEventListener('click', () => {
    selectPreset({ value:'custom', name:'Personalizado', dose:'' });
    qs('presetSearch').focus();
  });

  // ── SYRINGE ──
  function syringeMaxUI(type){
    if(type==='u100-0_3') return 30;
    if(type==='u100-0_5') return 50;
    return 100;
  }

  function roundToStep(value, step, tieRule){
    if(step===0) return value;
    const inv=value/step, lower=Math.floor(inv)*step, upper=Math.ceil(inv)*step;
    const dl=Math.abs(value-lower), du=Math.abs(upper-value);
    if(dl<du) return lower; if(du<dl) return upper;
    return tieRule==='down' ? lower : upper;
  }

  function getDilutionMl(){
    return qs('dilutionMode').value==='custom'
      ? toNum(qs('dilutionMlCustom').value)
      : toNum(qs('dilutionMlPreset').value);
  }

  function buildTicks(maxUI){
    const g=qs('ticks'); g.innerHTML='';
    const topY=96, bottomY=354, h=bottomY-topY;
    for(let ui=0;ui<=maxUI;ui+=2){
      const y=bottomY-(ui/maxUI)*h, isMajor=ui%10===0;
      const line=document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute('x1',isMajor?14:18); line.setAttribute('x2',28);
      line.setAttribute('y1',y); line.setAttribute('y2',y);
      line.setAttribute('stroke','currentColor');
      line.setAttribute('opacity',isMajor?'0.7':'0.35');
      line.setAttribute('stroke-width',isMajor?'1.8':'1');
      g.appendChild(line);
      if(isMajor){
        const txt=document.createElementNS("http://www.w3.org/2000/svg","text");
        txt.setAttribute('x',12); txt.setAttribute('y',y+4);
        txt.setAttribute('text-anchor','end'); txt.setAttribute('fill','currentColor');
        txt.setAttribute('opacity','0.5'); txt.setAttribute('font-size','9');
        txt.textContent=ui; g.appendChild(txt);
      }
    }
  }

  function setSyringe(ui, maxUI){
    buildTicks(maxUI);
    const topY=96, bottomY=354, h=bottomY-topY;
    const u=Math.max(0,Math.min(ui,maxUI));
    const fillH=(u/maxUI)*h, y=bottomY-fillH;
    qs('liquid').setAttribute('y',y);
    qs('liquid').setAttribute('height',fillH);
    qs('plungerBase').setAttribute('y1',y); qs('plungerBase').setAttribute('y2',y);
    qs('plungerLabel').setAttribute('y',y-6);
    qs('plungerLabel').textContent=Math.round(u)+' UI';
  }

  // ── UPDATE ──
  function update(){
    const vialMg=toNum(qs('vialMg').value);
    const dilutionMl=getDilutionMl();
    const doseValue=toNum(qs('doseValue').value);
    const doseUnit=qs('doseUnit').value;
    const rounding=toNum(qs('rounding').value);
    const tieRule=qs('tieRule').value;
    const syringeType=qs('syringeType').value;
    const alerts=qs('alerts'); alerts.innerHTML='';

    if(!(vialMg>0)||!(dilutionMl>0)||!(doseValue>0)){
      qs('heroUI').textContent='\u2014'; qs('heroML').textContent='Preencha os campos para calcular';
      qs('uiExact').textContent='\u2014'; qs('uiExactSub').textContent='';
      qs('uiShown').textContent='\u2014'; qs('uiShownSub').textContent='';
      qs('sumVial').textContent='\u2014'; qs('sumDil').textContent='\u2014';
      qs('sumDose').textContent='\u2014'; qs('sumAspire').textContent='\u2014';
      qs('roundingNote').textContent='';
      setSyringe(0,syringeMaxUI(syringeType)); return;
    }

    let doseMg, uiExact;
    if(doseUnit==='ui'){
      uiExact=doseValue; doseMg=(uiExact/100)*(vialMg/dilutionMl);
    } else {
      doseMg=(doseUnit==='mcg') ? doseValue/1000 : doseValue;
      uiExact=(doseMg*dilutionMl/vialMg)*100;
    }

    const mlExact=uiExact/100;
    const uiShown=rounding===0 ? uiExact : roundToStep(uiExact,rounding,tieRule);
    const mlShown=uiShown/100;
    const maxUI=syringeMaxUI(syringeType);

    qs('heroUI').textContent=fmt(uiShown,0)+' UI';
    qs('heroML').textContent='= '+fmt(mlShown,3)+' mL';
    qs('uiExact').textContent=fmt(uiExact,2)+' UI'; qs('uiExactSub').textContent=fmt(mlExact,3)+' mL';
    qs('uiShown').textContent=fmt(uiShown,0)+' UI'; qs('uiShownSub').textContent=fmt(mlShown,3)+' mL';
    qs('sumVial').textContent=fmt(vialMg,2)+' mg'; qs('sumDil').textContent=fmt(dilutionMl,2)+' mL';
    qs('sumDose').textContent=doseUnit==='ui' ? fmt(doseValue,0)+' UI' : fmt(doseMg,4)+' mg';
    qs('sumAspire').textContent=fmt(uiShown,0)+' UI';
    qs('roundingNote').textContent=rounding===0
      ? 'Exibindo valor exato (sem arredondamento).'
      : 'Arredondado para '+rounding+' UI \u2014 empate \u2192 '+(tieRule==='up'?'cima':'baixo')+'.';

    const arr=[];
    if(doseMg>vialMg) arr.push({type:'bad',msg:'\u26A0 Dose maior que o conte\u00FAdo total do vial. Verifique os campos.'});
    if(uiShown>maxUI){
      arr.push({type:'bad',msg:'\u26A0 '+fmt(uiShown,0)+' UI excede a capacidade da seringa ('+maxUI+' UI).'});
    } else {
      arr.push({type:'good',msg:'\u2713 Compat\u00EDvel com seringa de '+maxUI+' UI.'});
    }
    arr.push({type:'neutral',msg:'Este conversor \u00E9 educativo e n\u00E3o define dosagens.'});
    for(const item of arr){
      const d=document.createElement('div');
      d.className='alert'+(item.type?' '+item.type:'');
      d.textContent=item.msg; alerts.appendChild(d);
    }
    setSyringe(uiShown,maxUI);
  }

  function onDilutionModeChange(){
    const mode=qs('dilutionMode').value;
    qs('dilutionPresetWrap').style.display=mode==='preset'?'':'none';
    qs('dilutionCustomWrap').style.display=mode==='custom'?'':'none';
    update();
  }

  // ── THEME ── (also updates SVG liquid color directly)
  function setTheme(t){
    document.documentElement.setAttribute('data-theme',t);
    localStorage.setItem('aura_theme',t);
    qs('themeLabel').textContent=t==='dark'?'Escuro':'Claro';
    // Force SVG liquid color — CSS var() on SVG fill is unreliable after dynamic theme switch
    qs('liquid').setAttribute('fill', t==='dark' ? '#ffffff' : '#555555');
  }

  function copyLinkWithParams(){
    const p=new URLSearchParams();
    p.set('p',qs('preset').value);
    p.set('v',qs('vialMg').value);
    p.set('dm',qs('dilutionMode').value);
    p.set('dp',qs('dilutionMlPreset').value);
    p.set('dc',qs('dilutionMlCustom').value);
    p.set('dose',qs('doseValue').value);
    p.set('u',qs('doseUnit').value);
    p.set('s',qs('syringeType').value);
    p.set('r',qs('rounding').value);
    p.set('t',qs('tieRule').value);
    p.set('theme',document.documentElement.getAttribute('data-theme')||'light');
    const url=location.origin+location.pathname+'?'+p.toString();
    navigator.clipboard.writeText(url).then(()=>alert('Link copiado!')).catch(()=>prompt('Copie o link:',url));
  }

  function applyUrlParams(){
    const p=new URLSearchParams(window.location.search);
    const theme=p.get('theme'); if(theme) setTheme(theme);
    const syr=p.get('s'); if(syr) qs('syringeType').value=syr;
    const v=p.get('v'); if(v) qs('vialMg').value=v;
    const dm=p.get('dm'); if(dm) qs('dilutionMode').value=dm;
    const dp=p.get('dp'); if(dp) qs('dilutionMlPreset').value=dp;
    const dc=p.get('dc'); if(dc) qs('dilutionMlCustom').value=dc;
    onDilutionModeChange();
    const dose=p.get('dose'); if(dose) qs('doseValue').value=dose;
    const unit=p.get('u'); if(unit) qs('doseUnit').value=unit;
    const r=p.get('r'); if(r) qs('rounding').value=r;
    const tie=p.get('t'); if(tie) qs('tieRule').value=tie;
    // Restore preset search label
    const pr=p.get('p');
    if(pr && pr!=='custom'){
      const found=PRESET_LIST.find(i=>i.value===pr);
      if(found){ qs('presetSearch').value=found.label; qs('presetClear').style.display='block'; qs('preset').value=pr; applyPreset(found); return; }
    }
    update();
  }

  function resetAll(){
    qs('syringeType').value='u100-1';
    qs('doseValue').value=0.25;
    qs('doseUnit').value='mg';
    qs('preset').value='custom';
    qs('presetSearch').value='';
    qs('presetClear').style.display='none';
    qs('vialMg').value=10;
    qs('dilutionMode').value='preset';
    qs('dilutionMlPreset').value=2;
    qs('dilutionMlCustom').value=2.0;
    qs('rounding').value=2;
    qs('tieRule').value='up';
    onDilutionModeChange();
    update();
  }

  // Init
  const saved=localStorage.getItem('aura_theme');
  setTheme(saved||'light');
  applyUrlParams();

  // Events
  ['doseValue','doseUnit','vialMg','dilutionMlPreset','dilutionMlCustom','rounding','tieRule','syringeType']
    .forEach(id=>qs(id).addEventListener('input',update));
  qs('dilutionMode').addEventListener('change',onDilutionModeChange);
  qs('copyLinkBtn').addEventListener('click',copyLinkWithParams);
  qs('resetBtn').addEventListener('click',resetAll);
  qs('themeToggle').addEventListener('click',()=>{
    const cur=document.documentElement.getAttribute('data-theme')||'light';
    setTheme(cur==='dark'?'light':'dark');
  });
</script>
</body>
</html>
